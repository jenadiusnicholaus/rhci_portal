{% extends 'donations/base.html' %}
{% load static %}

{% block title %}My Profile | RHCI Donor Dashboard{% endblock %}
{% block header_title %}My Profile{% endblock %}

{% block content %}
<div class="row">
  <!-- Profile Card -->
  <div class="col-lg-4 mb-4">
    <div class="card">
      <div class="card-body text-center pt-4">
        {% if user.profile.photo %}
          <img src="{{ user.profile.photo.url }}" alt="{{ user.get_full_name }}" class="profile-avatar mb-3">
        {% else %}
          <div class="profile-avatar-placeholder mb-3">
            {{ user.first_name|make_list|first|upper }}{{ user.last_name|make_list|first|upper }}
          </div>
        {% endif %}
        
        <h4>{{ user.get_full_name }}</h4>
        <p class="text-muted mb-3">{{ user.email }}</p>
        
        <div class="donor-info">
          <div class="row g-0">
            <div class="col-4 donor-stat">
              <div class="stat-value">{{ total_donated|default:"0 TZS" }}</div>
              <div class="stat-label">Total Donated</div>
            </div>
            <div class="col-4 donor-stat">
              <div class="stat-value">{{ donations_count|default:"0" }}</div>
              <div class="stat-label">Donations</div>
            </div>
            <div class="col-4 donor-stat">
              <div class="stat-value">{{ impact_score|default:"0" }}</div>
              <div class="stat-label">Impact Score</div>
            </div>
          </div>
        </div>
        
        <div class="mt-4">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#profile-photo-modal">
            <i class="fas fa-camera me-2"></i> Change Photo
          </button>
        </div>
      </div>
    </div>
    
    <!-- Contact Information Card -->
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Contact Information</h5>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#contact-modal">
          <i class="fas fa-edit"></i>
        </button>
      </div>
      <div class="card-body">
        <div class="contact-info">
          <div class="contact-item">
            <div class="contact-label">Email</div>
            <div class="contact-value">{{ user.email }}</div>
          </div>
          <div class="contact-item">
            <div class="contact-label">Phone</div>
            <div class="contact-value">{{ user.profile.phone|default:"Not provided" }}</div>
          </div>
          <div class="contact-item">
            <div class="contact-label">Address</div>
            <div class="contact-value">{{ user.profile.address|default:"Not provided" }}</div>
          </div>
          <div class="contact-item">
            <div class="contact-label">City</div>
            <div class="contact-value">{{ user.profile.city|default:"Not provided" }}</div>
          </div>
          <div class="contact-item">
            <div class="contact-label">Country</div>
            <div class="contact-value">{{ user.profile.country|default:"Not provided" }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Account Details Card -->
  <div class="col-lg-8 mb-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Account Information</h5>
      </div>
      <div class="card-body">
        <form id="account-form" method="post" action="{% url 'update_profile' %}">
          {% csrf_token %}
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">First Name</label>
              <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Email Address</label>
              <input type="email" class="form-control" name="email" value="{{ user.email }}" disabled>
              <small class="form-text text-muted">Email cannot be changed. Contact support if needed.</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Preferred Language</label>
              <select class="form-select" name="language">
                <option value="en" {% if user.profile.language == 'en' %}selected{% endif %}>English</option>
                <option value="sw" {% if user.profile.language == 'sw' %}selected{% endif %}>Swahili</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" name="birth_date" value="{{ user.profile.birth_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Gender</label>
              <select class="form-select" name="gender">
                <option value="">Prefer not to say</option>
                <option value="male" {% if user.profile.gender == 'male' %}selected{% endif %}>Male</option>
                <option value="female" {% if user.profile.gender == 'female' %}selected{% endif %}>Female</option>
                <option value="other" {% if user.profile.gender == 'other' %}selected{% endif %}>Other</option>
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">About Me</label>
            <textarea class="form-control" name="bio" rows="4">{{ user.profile.bio }}</textarea>
          </div>
          
          <div class="text-end">
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Communication Preferences -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Communication Preferences</h5>
      </div>
      <div class="card-body">
        <form id="preferences-form" method="post" action="{% url 'update_preferences' %}">
          {% csrf_token %}
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="email_updates" name="email_updates" {% if user.profile.email_updates %}checked{% endif %}>
              <label class="form-check-label" for="email_updates">Email Updates</label>
              <div class="form-text">Receive updates about patients you're supporting</div>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="sms_updates" name="sms_updates" {% if user.profile.sms_updates %}checked{% endif %}>
              <label class="form-check-label" for="sms_updates">SMS Updates</label>
              <div class="form-text">Receive text message updates about urgent cases</div>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="newsletter" name="newsletter" {% if user.profile.newsletter %}checked{% endif %}>
              <label class="form-check-label" for="newsletter">Newsletter</label>
              <div class="form-text">Receive our monthly newsletter with stories and impact reports</div>
            </div>
          </div>
          
          <div class="text-end">
            <button type="submit" class="btn btn-primary">Save Preferences</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Security Settings -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Security</h5>
      </div>
      <div class="card-body">
        <p class="mb-4">Secure your account with a strong password and two-factor authentication.</p>
        
        <div class="d-grid gap-2">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#password-modal">
            <i class="fas fa-key me-2"></i> Change Password
          </button>
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#tfa-modal">
            <i class="fas fa-shield-alt me-2"></i> Set Up Two-Factor Authentication
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Photo Modal -->
<div class="modal fade" id="profile-photo-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Profile Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="photo-form" method="post" action="{% url 'update_photo' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3 text-center">
            <div class="photo-preview-container mb-3">
              {% if user.profile.photo %}
                <img src="{{ user.profile.photo.url }}" alt="Profile photo preview" class="photo-preview">
              {% else %}
                <div class="photo-preview-placeholder">
                  {{ user.first_name|make_list|first|upper }}{{ user.last_name|make_list|first|upper }}
                </div>
              {% endif %}
            </div>
            
            <label for="photo-upload" class="btn btn-outline-primary">
              <i class="fas fa-upload me-2"></i> Select New Photo
            </label>
            <input type="file" id="photo-upload" name="photo" class="d-none" accept="image/*">
            <div class="form-text mt-2">Maximum file size: 5MB. Supported formats: JPG, PNG</div>
          </div>
          
          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary">Upload Photo</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Contact Information Modal -->
<div class="modal fade" id="contact-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Contact Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="contact-form" method="post" action="{% url 'update_contact' %}">
          {% csrf_token %}
          
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="tel" class="form-control" name="phone" value="{{ user.profile.phone }}">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Address</label>
            <input type="text" class="form-control" name="address" value="{{ user.profile.address }}">
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">City</label>
              <input type="text" class="form-control" name="city" value="{{ user.profile.city }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Postal Code</label>
              <input type="text" class="form-control" name="postal_code" value="{{ user.profile.postal_code }}">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Country</label>
            <select class="form-select" name="country">
              <option value="">Select country</option>
              <option value="TZ" {% if user.profile.country == 'TZ' %}selected{% endif %}>Tanzania</option>
              <option value="KE" {% if user.profile.country == 'KE' %}selected{% endif %}>Kenya</option>
              <option value="UG" {% if user.profile.country == 'UG' %}selected{% endif %}>Uganda</option>
              <option value="US" {% if user.profile.country == 'US' %}selected{% endif %}>United States</option>
              <option value="GB" {% if user.profile.country == 'GB' %}selected{% endif %}>United Kingdom</option>
            </select>
          </div>
          
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Save Contact Info</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="password-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="password-form" method="post" action="{% url 'change_password' %}">
          {% csrf_token %}
          
          <div class="mb-3">
            <label class="form-label">Current Password</label>
            <input type="password" class="form-control" name="current_password" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input type="password" class="form-control" name="new_password" required>
            <div class="form-text">Password must be at least 8 characters long with numbers and special characters.</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" name="confirm_password" required>
          </div>
          
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Change Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Profile Avatar */
  .profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid var(--primary);
    margin: 0 auto;
  }
  
  .profile-avatar-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 600;
    margin: 0 auto;
    border: 4px solid var(--primary-light);
  }
  
  /* Donor Stats */
  .donor-info {
    margin: 1.5rem 0;
    border-top: 1px solid var(--gray-light);
    border-bottom: 1px solid var(--gray-light);
    padding: 1rem 0;
  }
  
  .donor-stat {
    padding: 0.5rem;
  }
  
  .stat-value {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: var(--gray);
  }
  
  /* Contact Information */
  .contact-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
{% endblock %}
